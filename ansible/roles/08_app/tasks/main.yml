---
- name: git clone app
  become_user: root
  git: 
    repo: https://github.com/yuta-ushijima/raisetech-live8-sample-app.git
    dest: "{{ sample_app_dir }}"
    force: yes
  register: git_clone

- name: change owner /var/www/raisetech-live8-sample-app
  become_user: root
  file:
    path: "{{ sample_app_dir }}"
    state: directory
    owner: ec2-user
    recurse: yes
  when: git_clone.changed

- name: create database.yml
  become_user: root
  template:
    src: database.yml.j2
    dest: "{{ sample_app_dir }}/config/database.yml"

- name: create storage.yml
  become_user: root
  template:
    src: storage.yml.j2
    dest: "{{ sample_app_dir }}/config/storage.yml"

- name: Install rbenv
  become_user: root
  shell: |
    git clone https://github.com/rbenv/rbenv.git /usr/local/rbenv
    echo 'export PATH="/usr/local/rbenv/bin:$PATH"' >> ~/.bash_profile
    echo 'eval "$(rbenv init -)"' >> ~/.bash_profile

- name: Install dependencies for rbenv
  yum:
    name: 
      - git
      - gcc
      - openssl-devel
      - readline-devel
      - zlib-devel
    state: present

- name: Clone ruby-build repository
  git:
    repo: 'https://github.com/rbenv/ruby-build.git'
    dest: /usr/local/rbenv/plugins/ruby-build
    version: master
    force: yes

- name: Add rbenv to PATH
  lineinfile:
    path: /etc/profile.d/rbenv.sh
    line: 'export PATH="/usr/local/rbenv/bin:$PATH"'
    create: yes
    state: present

- name: Initialize rbenv
  lineinfile:
    path: /etc/profile.d/rbenv.sh
    line: 'eval "$(rbenv init -)"'
    create: yes
    state: present

- name: Ensure profile.d scripts are executable
  file:
    path: /etc/profile.d/rbenv.sh
    mode: '0755'
    state: file

- name: Rehash rbenv
  command: bash -lc 'rbenv rehash'
  environment:
    PATH: "/usr/local/rbenv/bin:{{ ansible_env.PATH }}"

- name: Set global Ruby version
  command: /usr/local/rbenv/bin/rbenv global 3.1.2
  environment:
    RBENV_ROOT: /usr/local/rbenv

- name: Install Rails
  command: bash -lc 'gem install rails -v 7.1.3.2'
  environment:
    PATH: "/usr/local/rbenv/shims:/usr/local/rbenv/bin:{{ ansible_env.PATH }}"

- name: Check Rails version
  command: bash -lc 'rails -v'
  environment:
    PATH: "/usr/local/rbenv/shims:/usr/local/rbenv/bin:{{ ansible_env.PATH }}"
  register: rails_version_check

- debug:
    msg: "Rails version is {{ rails_version_check.stdout }}"
