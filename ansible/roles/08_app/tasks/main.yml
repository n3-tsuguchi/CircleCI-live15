- name: git clone app
  become_user: root
  git: 
    repo: https://github.com/yuta-ushijima/raisetech-live8-sample-app.git
    dest: "{{ sample_app_dir }}"
    force: yes
  register: git_clone

- name: change owner /var/www/raisetech-live8-sample-app
  become_user: root
  file:
    path: "{{ sample_app_dir }}"
    state: directory
    owner: ec2-user
    recurse: yes
  when: git_clone.changed

- name: create database.yml
  become_user: root
  copy:
    content: |
      # Your database.yml content here
    dest: "{{ sample_app_dir }}/config/database.yml"

- name: create storage.yml
  become_user: root
  copy:
    content: |
      # Your storage.yml content here
    dest: "{{ sample_app_dir }}/config/storage.yml"

- name: edit unicorn.rb
  become_user: root
  copy:
    content: |
      # Your unicorn.rb content here
    dest: "{{ sample_app_dir }}/config/unicorn.rb"

- name: edit development.rb
  become_user: root
  copy:
    content: |
      # Your development.rb content here
    dest: "{{ sample_app_dir }}/config/environments/development.rb"

- name: Install Ruby 3.2.3
  become: true
  command: bash -lc "rbenv install -s 3.2.3"
  environment:
    PATH: "/usr/local/rbenv/bin:/usr/local/rbenv/shims:{{ ansible_env.PATH }}"

- name: Set Ruby 3.2.3 as global default
  become: true
  command: bash -lc "rbenv global 3.2.3"
  environment:
    PATH: "/usr/local/rbenv/bin:/usr/local/rbenv/shims:{{ ansible_env.PATH }}"

- name: Ensure .ruby-version is correct
  become_user: root
  copy:
    content: "3.2.3\n"
    dest: "{{ sample_app_dir }}/.ruby-version"

- name: Install Bundler
  become: true
  command: bash -lc "gem install bundler"
  environment:
    PATH: "/usr/local/rbenv/bin:/usr/local/rbenv/shims:{{ ansible_env.PATH }}"

- name: Run bundle install
  become: true
  command: bash -lc "cd {{ sample_app_dir }} && bundle install"
  environment:
    PATH: "/usr/local/rbenv/bin:/usr/local/rbenv/shims:{{ ansible_env.PATH }}"

- name: Ensure Unicorn is running
  become: true
  command: bash -lc "bundle exec unicorn_rails -c config/unicorn.rb"
  environment:
    PATH: "/usr/local/rbenv/bin:/usr/local/rbenv/shims:{{ ansible_env.PATH }}"

