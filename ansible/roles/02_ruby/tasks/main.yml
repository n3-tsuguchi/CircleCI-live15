---
- name: rbenvのインストール確認
  shell: bash -lc "rbenv --version"
  register: check_rbenv_installed
  changed_when: no
  ignore_errors: yes

- name: rbenvのインストール
  git:
    repo: https://github.com/sstephenson/rbenv.git
    dest: /home/circleci/.rbenv
  when: check_rbenv_installed.failed

- name: PATHにrbenvを追加
  lineinfile:
    path: /home/circleci/.bash_profile
    line: 'export PATH="$HOME/.rbenv/bin:$PATH"'
    create: yes
  when: check_rbenv_installed.failed

- name: rbenv initの評価
  lineinfile:
    path: /home/circleci/.bash_profile
    line: 'eval "$(rbenv init -)"'
    create: yes
  when: check_rbenv_installed.failed

- name: .bash_profileの読み込み
  shell: bash -lc "source ~/.bash_profile"
  when: check_rbenv_installed.failed

- name: ruby-buildのインストール
  git:
    repo: https://github.com/sstephenson/ruby-build.git
    dest: /home/circleci/.rbenv/plugins/ruby-build
  when: check_rbenv_installed.failed

- name: Rubyのインストール
  shell: bash -lc "RUBY_CFLAGS='-O3' rbenv install --skip-existing {{ ruby_version }}"
  environment:
    PATH: "/home/circleci/.rbenv/bin:/home/circleci/.rbenv/plugins/ruby-build/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  when: check_rbenv_installed.failed

- name: rbenvの再ハッシュ
  shell: bash -lc "rbenv rehash"
  environment:
    PATH: "/home/circleci/.rbenv/bin:/home/circleci/.rbenv/plugins/ruby-build/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  when: check_rbenv_installed.failed

- name: デフォルトのRubyバージョンを設定
  shell: bash -lc "rbenv global {{ ruby_version }}"
  environment:
    PATH: "/home/circleci/.rbenv/bin:/home/circleci/.rbenv/plugins/ruby-build/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  when: check_rbenv_installed.failed
